{% extends "baseApp.html" %}
{% load static %}
{% block title %}Résultats de recherche{% endblock %}

{% block content %}
<div class="mt-16 px-4">
  <h2 class="text-white text-4xl mb-8">Recherche : "{{ query }}"</h2>

  <!-- Section : Films et Séries -->
  {% if videos %}
    <h3 class="text-white text-2xl mt-8 mb-4">Films & Séries</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for video in videos %}
        <!-- Tu dois créer ce partial ou l’adapter -->
        <a href="{% url 'video_player' video.id %}" class="group">
          <div class="relative rounded-xl overflow-hidden shadow-lg aspect-video bg-gray-800">
            {% if video.cover_image %}
              <img src="{{ video.cover_image }}" alt="{{ video.title }}"
                   class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
            {% else %}
              <div class="w-full h-full flex items-center justify-center bg-gray-700">
                <i class="bx bx-film text-4xl text-gray-500"></i>
              </div>
            {% endif %}
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black p-3">
              <h4 class="text-white font-medium line-clamp-2">{{ video.title }}</h4>
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Section : Photos -->
  {% if photos %}
  <div class="mt-16 max-w-7xl mx-auto">
    <h2 class="text-white text-3xl sm:text-4xl md:text-5xl font-normal mb-8">Photos</h2>
    <div class="columns-2 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-4 space-y-6">
      {% for photo in photos %}
        <div class="break-inside-avoid group cursor-pointer" 
             onclick="openSwipeModal({{ photo.id }}, '{{ photo.photo_file|default:''|escapejs }}', '{{ photo.title|escapejs }}', '{{ photo.description|escapejs|default:'' }}', '{{ photo.user.username|escapejs }}', '{{ photo.created_at|date:"d/m/Y"|escapejs }}')">
          <div class="relative overflow-hidden rounded-xl shadow-lg transition-all duration-500 hover:scale-105 hover:shadow-2xl">
            <img
              src="{{ photo.photo_file|default:'' }}"
              alt="{{ photo.title|default:'Photo' }}"
              class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-110"
              loading="lazy"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end">
              <p class="text-white px-4 pb-4 text-sm sm:text-base font-medium truncate">{{ photo.title|truncatechars:30 }}</p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Aucun résultat -->
  {% if not videos and not photos and query %}
    <p class="text-white mt-8 text-xl">Aucun résultat trouvé pour "<strong>{{ query }}</strong>"</p>
  {% endif %}
</div>

<!-- Modale de Swipe (Tinder Style) -->
<div id="swipe-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
  <div class="relative w-full max-w-md aspect-[3/4] bg-gray-900 rounded-2xl overflow-hidden shadow-2xl">
    <img id="swipe-img" class="w-full h-full object-cover" src="" alt="Photo">
    <div class="absolute bottom-0 left-0 right-0 p-5 bg-gradient-to-t from-black via-transparent to-transparent text-white">
      <h3 id="swipe-title" class="text-xl font-bold"></h3>
      <p id="swipe-desc" class="text-sm text-gray-200 mt-1 line-clamp-2"></p>
      <div class="flex justify-between items-center mt-3 text-xs text-gray-300">
        <span>Par <strong id="swipe-author"></strong></span>
        <span id="swipe-date"></span>
      </div>
    </div>
    <button onclick="prevPhoto()" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white">
      <i class='bx bx-chevron-left text-xl'></i>
    </button>
    <button onclick="nextPhoto()" class="absolute right-4 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white">
      <i class='bx bx-chevron-right text-xl'></i>
    </button>
    <button onclick="closeSwipeModal()" class="absolute top-4 right-4 w-10 h-10 bg-black/60 rounded-full flex items-center justify-center text-white">
      <i class='bx bx-x text-xl'></i>
    </button>
    {% if has_active_subscription %}
      <a id="download-btn" href="#" download class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-[#a21892] hover:bg-[#8a147d] text-white px-6 py-2.5 rounded-full text-sm font-medium transition-colors z-10">
        Télécharger
      </a>
    {% else %}
      <button onclick="alert('Abonnez-vous pour télécharger !')" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-600 text-white px-6 py-2.5 rounded-full text-sm font-medium cursor-not-allowed">
        Télécharger
      </button>
    {% endif %}
  </div>
</div>

<!-- Boxicons + Hammer.js -->
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

<script>
  const photoList = [
    {% for photo in photos %}
      {
        id: {{ photo.id }},
        url: "{{ photo.photo_file|default:''|escapejs }}",
        title: "{{ photo.title|escapejs }}",
        description: "{{ photo.description|escapejs|default:'' }}",
        author: "{{ photo.user.username|escapejs }}",
        date: "{{ photo.created_at|date:'d/m/Y'|escapejs }}",
        downloadUrl: "{% if has_active_subscription %}{{ photo.photo_file|default:''|escapejs }}{% else %}#{% endif %}"
      },
    {% endfor %}
  ];

  let currentIndex = 0;

  function openSwipeModal(id) {
    const photo = photoList.find(p => p.id === id);
    if (!photo) return;
    currentIndex = photoList.indexOf(photo);
    updateSwipeModal();
    document.getElementById('swipe-modal').classList.remove('hidden');
    setupSwipeGesture();
  }

  function updateSwipeModal() {
    const photo = photoList[currentIndex];
    if (!photo) return;
    document.getElementById('swipe-img').src = photo.url;
    document.getElementById('swipe-title').textContent = photo.title || 'Sans titre';
    document.getElementById('swipe-desc').textContent = photo.description || '';
    document.getElementById('swipe-author').textContent = photo.author;
    document.getElementById('swipe-date').textContent = photo.date;
    const btn = document.getElementById('download-btn');
    if (btn && photo.downloadUrl) btn.href = photo.downloadUrl;
  }

  function nextPhoto() { if (currentIndex < photoList.length - 1) { currentIndex++; updateSwipeModal(); } }
  function prevPhoto() { if (currentIndex > 0) { currentIndex--; updateSwipeModal(); } }
  function closeSwipeModal() { document.getElementById('swipe-modal').classList.add('hidden'); }

  function setupSwipeGesture() {
    const el = document.querySelector('#swipe-modal .relative');
    if (!el) return;
    const mc = new Hammer(el);
    mc.on('swipeleft', nextPhoto);
    mc.on('swiperight', prevPhoto);
  }

  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSwipeModal(); });
</script>


{% endblock %}