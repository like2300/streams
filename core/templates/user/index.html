{% extends "baseApp.html" %}
{% load static %}

{% block title %}Accueil{% endblock %}

{% block extra_css %}
  <style>
    [data-gradient-border] {
      position: relative;
    }
    [data-gradient-border]::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 1rem;
      background: linear-gradient(45deg, #a2189279, #e959c043, #a2189200);
      z-index: -1;
      pointer-events: none;
    }
  </style>
{% endblock %}

{% block content %}

<!-- Slider Container -->
<div class="w-full h-72 sm:h-96 md:h-[475px] mt-8 rounded-3xl overflow-hidden shadow-2xl relative group" style="border: 2px solid transparent;" data-gradient-border>
  <div id="slider" class="w-full h-full bg-cover bg-center transition-all duration-1000 ease-in-out"></div>

  <!-- Text Overlay -->
  <p id="slide-text"
     class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white text-3xl sm:text-4xl md:text-5xl lg:text-7xl font-light text-center px-6 leading-tight tracking-wide drop-shadow-lg">
  </p>

  <!-- Navigation Dots -->
  <div id="dots" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-3 z-20"></div>

  <!-- Navigation Arrows -->
  <button id="prev"
          aria-label="Slide précédente"
          class="absolute left-3 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-black/40 hover:bg-black/60 text-white rounded-full flex items-center justify-center transition-all duration-300 opacity-0 group-hover:opacity-100 z-30 backdrop-blur-sm">
    <i class='bx bx-chevron-left text-xl'></i>
  </button>
  <button id="next"
          aria-label="Slide suivante"
          class="absolute right-3 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-black/40 hover:bg-black/60 text-white rounded-full flex items-center justify-center transition-all duration-300 opacity-0 group-hover:opacity-100 z-30 backdrop-blur-sm">
    <i class='bx bx-chevron-right text-xl'></i>
  </button>
</div>

<!-- Main Content -->
<div class="mt-16 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

  <!-- Section: Films & Séries -->
  <section class="mb-16">
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between mb-8">
      <div class="mb-4 sm:mb-0">
        <h2 class="text-white text-3xl sm:text-4xl md:text-5xl font-normal leading-tight">Films et Séries</h2>
        <p class="text-gray-400 text-base sm:text-lg mt-2">Sexy photos · Modèle sexy · Charme</p>
      </div>
      <a href="{% url 'video_user' %}"
         class="inline-flex items-center gap-2 bg-[#a21892] hover:bg-[#8a147d] text-white px-6 py-2.5 rounded-full text-sm font-medium transition-colors duration-300">
        <span>Voir plus</span>
        <i class='bx bx-chevron-right text-lg'></i>
      </a>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for video in videos %}
        {% include "partials/_videos.html" %}
      {% empty %}
        <p class="text-gray-500 col-span-full text-center py-4">Aucune vidéo disponible.</p>
      {% endfor %}
    </div>
  </section>

  <!-- Section: Photos -->
  <section class="mb-16">
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between mb-8">
      <div class="mb-4 sm:mb-0">
        <h2 class="text-white text-3xl sm:text-4xl md:text-5xl font-normal leading-tight">Photos</h2>
        <p class="text-gray-400 text-base sm:text-lg mt-2">Sexy photos · Modèle sexy · Charme</p>
      </div>
      <a href="{% url 'photo_user' %}"
         class="inline-flex items-center gap-2 bg-[#a21892] hover:bg-[#8a147d] text-white px-6 py-2.5 rounded-full text-sm font-medium transition-colors duration-300">
        <span>Voir plus</span>
        <i class='bx bx-chevron-right text-lg'></i>
      </a>
    </div>

    <div class="columns-2 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-4 space-y-4">
      {% for photo in photos %}
        <div class="break-inside-avoid group cursor-pointer" onclick="openSwipeModal({{ photo.id }})">
          <div class="relative overflow-hidden rounded-xl shadow-lg transition-all duration-500 hover:scale-105 hover:shadow-2xl">
            <img
              src="{{ photo.photo_file|default:'' }}"
              alt="{{ photo.title|default:'Photo' }}"
              class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-110"
              loading="lazy"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end">
              <p class="text-white px-4 pb-4 text-sm sm:text-base font-medium truncate">{{ photo.title|truncatechars:30 }}</p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </section>
</div>

<!-- Modale de Swipe Responsive -->
<div id="swipe-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
  <div class="relative w-full max-w-4xl max-h-[90vh] bg-gray-900 rounded-2xl overflow-hidden shadow-2xl">
    <img id="swipe-img" class="w-full h-auto max-h-[70vh] object-contain bg-black" src="" alt="Photo" />
    
    <div class="absolute bottom-0 left-0 right-0 p-5 bg-gradient-to-t from-black via-transparent to-transparent text-white">
      <h3 id="swipe-title" class="text-xl font-bold"></h3>
      <p id="swipe-desc" class="text-sm text-gray-200 mt-1 line-clamp-2"></p>
      <div class="flex justify-between items-center mt-3 text-xs text-gray-300">
        <span>Par <strong id="swipe-author"></strong></span>
        <span id="swipe-date"></span>
      </div>
    </div>

    <button onclick="prevPhoto()" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition">
      <i class='bx bx-chevron-left text-xl'></i>
    </button>
    <button onclick="nextPhoto()" class="absolute right-4 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition">
      <i class='bx bx-chevron-right text-xl'></i>
    </button>
    <button onclick="closeSwipeModal()" class="absolute top-4 right-4 w-10 h-10 bg-black/60 rounded-full flex items-center justify-center text-white hover:bg-black/80 transition">
      <i class='bx bx-x text-xl'></i>
    </button>

    {% if has_active_subscription %}
      <a id="download-btn" href="#" download class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-[#a21892] hover:bg-[#8a147d] text-white px-6 py-2.5 rounded-full text-sm font-medium transition-colors z-10">
        Télécharger
      </a>
    {% else %}
      <button id="download-btn" onclick="alert('Abonnez-vous pour télécharger !')" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-600 text-white px-6 py-2.5 rounded-full text-sm font-medium">
        Télécharger
      </button>
    {% endif %}
  </div>
</div>

<!-- Scripts -->
<script>
  // --- Slider ---
  const slides = [
    {% for slide in slides %}
      {
        image: "{{ slide.image|escapejs }}",
        text: "{{ slide.text|escapejs }}",
        videoId: "{{ slide.video_id|escapejs }}"
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  let currentIndex = 0;
  const slider = document.getElementById("slider");
  const slideText = document.getElementById("slide-text");
  const dotsContainer = document.getElementById("dots");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");

  function createDots() {
    dotsContainer.innerHTML = '';
    slides.forEach((_, index) => {
      const dot = document.createElement('div');
      dot.className = `w-4 h-4 rounded-full cursor-pointer ${index === currentIndex ? 'bg-[#ba0fb49e]' : 'bg-white'}`;
      dot.addEventListener("click", () => goToSlide(index));
      dotsContainer.appendChild(dot);
    });
  }

  function updateSlider() {
    if (slides.length === 0) return;
    slider.style.backgroundImage = `url('${slides[currentIndex].image}')`;
    slideText.textContent = slides[currentIndex].text;
    createDots();
  }

  function goToSlide(index) {
    currentIndex = index;
    updateSlider();
    resetAutoPlay();
  }

  function nextSlide() {
    currentIndex = (currentIndex + 1) % slides.length;
    updateSlider();
  }

  function prevSlide() {
    currentIndex = (currentIndex - 1 + slides.length) % slides.length;
    updateSlider();
  }

  let autoPlayInterval = setInterval(nextSlide, 5000);
  function resetAutoPlay() {
    clearInterval(autoPlayInterval);
    autoPlayInterval = setInterval(nextSlide, 5000);
  }

  nextBtn?.addEventListener("click", () => { nextSlide(); resetAutoPlay(); });
  prevBtn?.addEventListener("click", () => { prevSlide(); resetAutoPlay(); });
  slider?.addEventListener("click", () => {
    if (slides[currentIndex]?.videoId) {
      window.location.href = `/video/player/${slides[currentIndex].videoId}/`;
    }
  });

  createDots();
  updateSlider();

  // --- Photo Swipe Modal ---
  const photoList = [
    {% for photo in photos %}
      {
        id: {{ photo.id }},
        url: "{{ photo.photo_file|default:''|escapejs }}",
        title: "{{ photo.title|escapejs }}",
        description: "{{ photo.description|escapejs|default:'' }}",
        author: "{{ photo.user.username|escapejs }}",
        date: "{{ photo.created_at|date:'d/m/Y'|escapejs }}",
        downloadUrl: "{% if has_active_subscription %}{{ photo.photo_file|escapejs }}{% endif %}"
      },
    {% endfor %}
  ];

  let currentPhotoIndex = 0;

  function openSwipeModal(id) {
    const photo = photoList.find(p => p.id === id);
    if (!photo) return;
    currentPhotoIndex = photoList.indexOf(photo);
    updateSwipeModal();
    document.getElementById('swipe-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function updateSwipeModal() {
    const photo = photoList[currentPhotoIndex];
    if (!photo) return;
    document.getElementById('swipe-img').src = photo.url;
    document.getElementById('swipe-title').textContent = photo.title || 'Sans titre';
    document.getElementById('swipe-desc').textContent = photo.description || '';
    document.getElementById('swipe-author').textContent = photo.author;
    document.getElementById('swipe-date').textContent = photo.date;

    const btn = document.getElementById('download-btn');
    if (btn && photo.downloadUrl) {
      if (btn.tagName === 'A') btn.href = photo.downloadUrl;
    }
  }

  function nextPhoto() {
    if (currentPhotoIndex < photoList.length - 1) {
      currentPhotoIndex++;
      updateSwipeModal();
    }
  }

  function prevPhoto() {
    if (currentPhotoIndex > 0) {
      currentPhotoIndex--;
      updateSwipeModal();
    }
  }

  function closeSwipeModal() {
    document.getElementById('swipe-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  // Fermeture
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSwipeModal(); });
  document.getElementById('swipe-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'swipe-modal') closeSwipeModal();
  });
</script>

{% endblock %}