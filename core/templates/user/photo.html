{% extends "baseApp.html" %}
{% load static %}
{% block title %}Résultats de recherche{% endblock %}

{% block content %}
<div class="mt-16 px-4"> 

    
  {% if photos %}
  <div class="mt-16 max-w-7xl mx-auto">
    <h2 class="text-white text-3xl sm:text-4xl md:text-5xl font-normal mb-8">Photos</h2>
    <div class="columns-2 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-4 space-y-6">
      {% for photo in photos %}
        <div class="break-inside-avoid group cursor-pointer" 
             onclick="openSwipeModal({{ photo.id }})">
          <div class="relative overflow-hidden rounded-xl shadow-lg transition-all duration-500 hover:scale-105 hover:shadow-2xl">
            <img
              src="{{ photo.photo_file|default:'' }}"
              alt="{{ photo.title|default:'Photo' }}"
              class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-110"
              loading="lazy"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end">
              <p class="text-white px-4 pb-4 text-sm sm:text-base font-medium truncate">{{ photo.title|truncatechars:30 }}</p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Aucun résultat -->
  {% if not videos and not photos and query %}
    <p class="text-white mt-8 text-xl">Aucun résultat trouvé pour "<strong>{{ query }}</strong>"</p>
  {% endif %}
</div>


<!-- Modale de Swipe avec Like & Commentaires -->
<div id="swipe-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
  <div class="relative w-full max-w-4xl max-h-[90vh] bg-gray-900 rounded-2xl overflow-hidden shadow-2xl">
    <img id="swipe-img" class="w-full h-auto max-h-[60vh] object-contain bg-black" src="" alt="Photo" />

    <div class="absolute bottom-0 left-0 right-0 p-5 bg-gradient-to-t from-black via-transparent to-transparent text-white">
      <h3 id="swipe-title" class="text-xl font-bold"></h3>
      <p id="swipe-desc" class="text-sm text-gray-200 mt-1 line-clamp-2"></p>
      <div class="flex justify-between items-center mt-3 text-xs text-gray-300">
        <span>Par <strong id="swipe-author"></strong></span>
        <span id="swipe-date"></span>
      </div>
    </div>

    <!-- Boutons Like / Commentaires -->
    <div class="absolute top-4 left-4 flex gap-3">
      <button id="like-btn" class="flex items-center gap-1 bg-black/60 hover:bg-black/80 px-3 py-1.5 rounded-full text-white text-sm transition">
        <i id="like-icon" class='bx bx-heart text-lg'></i>
        <span id="like-count" class="font-medium">0</span>
      </button>
      <button id="comment-btn" class="flex items-center gap-1 bg-black/60 hover:bg-black/80 px-3 py-1.5 rounded-full text-white text-sm transition">
        <i class='bx bx-message-rounded text-lg'></i>
        <span id="comment-count" class="font-medium">0</span>
      </button>
    </div>

    <!-- Navigation -->
    <button id="prev-btn" class="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition">
      <i class='bx bx-chevron-left text-xl'></i>
    </button>
    <button id="next-btn" class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition">
      <i class='bx bx-chevron-right text-xl'></i>
    </button>
    <button id="close-swipe" class="absolute top-4 right-4 w-10 h-10 bg-black/60 rounded-full flex items-center justify-center text-white hover:bg-black/80 transition">
      <i class='bx bx-x text-xl'></i>
    </button>

    <!-- Téléchargement -->
    {% if has_active_subscription %}
      <a id="download-btn" href="#" download class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-[#1769c2] hover:bg-[#178cbe] text-white px-6 py-2.5 rounded-full text-sm font-medium transition">
        Télécharger
      </a>
    {% else %}
      <button id="download-disabled" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-gray-600 text-white px-6 py-2.5 rounded-full text-sm font-medium">
        Télécharger
      </button>
    {% endif %}
  </div>
</div>

<!-- Sidebar des commentaires -->
<div id="comments-sidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-[#050e16] shadow-2xl z-[88888] transform translate-x-full transition-transform duration-300 overflow-hidden">
  <div class="p-6 flex flex-col h-full">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold text-white">Commentaires</h2>
      <button id="close-comments" class="text-gray-400 hover:text-white">
        <i class='bx bx-x text-2xl'></i>
      </button>
    </div>

     <!-- Formulaire de commentaire en bas -->
    <form id="comment-form" class="border-t border-gray-800 pb-4">
      <div class="flex gap-2">
        <input
          type="text"
          name="text"
          placeholder="Ajouter un commentaire..."
          class="flex-1 bg-gray-700/50 border border-gray-600 rounded-full px-4 py-2 text-white focus:outline-none focus:border-purple-500"
          required>
        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white rounded-full p-2">
          <i class="material-icons">send</i>
        </button>
      </div>
    </form>


    <!-- Zone de défilement pour les commentaires -->
    <div id="comments-list" class="flex-1 overflow-y-auto space-y-4 pb-6">
      <!-- Style personnalisé pour le scroll -->
      <style>
        #comments-list::-webkit-scrollbar {
          width: 6px;
        }
        #comments-list::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.05);
          border-radius: 3px;
        }
        #comments-list::-webkit-scrollbar-thumb {
          background: rgba(161, 24, 146, 0.5);
          border-radius: 3px;
        }
        #comments-list::-webkit-scrollbar-thumb:hover {
          background: rgba(161, 24, 146, 0.7);
        }
      </style>
      
      <!-- Les commentaires seront chargés dynamiquement -->
    </div>

     <div class="md:hidden">
                    <br>
                    <br>
                    <br>
                    <br>
                    
                </div>

   
  </div>
</div>

<div id="comments-overlay" class="fixed inset-0 bg-black/50 z-49 hidden"></div>

<!-- Boxicons + Hammer.js -->
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>




<script>
  // === SLIDER LOGIC ===
  document.addEventListener('DOMContentLoaded', function () {
    const slides = {{ slides|safe }};
    if (!slides || slides.length === 0) return;

    const slider = document.getElementById('slider');
    const slideText = document.getElementById('slide-text');
    const dotsContainer = document.getElementById('dots');
    let currentIndex = 0;
    let intervalId = null;

    function createDots() {
      slides.forEach((_, i) => {
        const dot = document.createElement('button');
        dot.setAttribute('aria-label', `Aller à la slide ${i + 1}`);
        dot.className = 'w-2.5 h-2.5 rounded-full transition-colors duration-300';
        dot.addEventListener('click', () => {
          goToSlide(i);
          resetInterval();
        });
        dotsContainer.appendChild(dot);
      });
    }

    function updateDots(index) {
      Array.from(dotsContainer.children).forEach((dot, i) => {
        dot.classList.toggle('bg-white', i === index);
        dot.classList.toggle('bg-white/40', i !== index);
      });
    }

    function goToSlide(index) {
      currentIndex = index;
      const slide = slides[index];
      
      // Preload image
      const img = new Image();
      img.onload = () => {
        slider.style.backgroundImage = `url(${slide.image})`;
        slideText.textContent = slide.text;
        slider.parentElement.setAttribute('onclick', `window.location.href='/video/player/${slide.video_id}/'`);
        updateDots(index);
      };
      img.src = slide.image;
    }

    function nextSlide() {
      currentIndex = (currentIndex + 1) % slides.length;
      goToSlide(currentIndex);
    }

    function prevSlide() {
      currentIndex = (currentIndex - 1 + slides.length) % slides.length;
      goToSlide(currentIndex);
    }

    function startInterval() {
      intervalId = setInterval(nextSlide, 5000);
    }

    function resetInterval() {
      clearInterval(intervalId);
      startInterval();
    }

    document.getElementById('next').addEventListener('click', (e) => {
      e.stopPropagation();
      nextSlide();
      resetInterval();
    });

    document.getElementById('prev').addEventListener('click', (e) => {
      e.stopPropagation();
      prevSlide();
      resetInterval();
    });

    createDots();
    goToSlide(0);
    startInterval();
  });


  // === MODAL & COMMENTS LOGIC ===
  const photoList = [
    {% for photo in photos %}
      {
        id: {{ photo.id }},
        url: "{{ photo.photo_file|default:''|escapejs }}",
        title: "{{ photo.title|escapejs }}",
        description: "{{ photo.description|escapejs|default:'' }}",
        author: "{{ photo.user.username|escapejs }}",
        date: "{{ photo.created_at|date:'d/m/Y'|escapejs }}",
        comment_count: {{ photo.comment_count }}
      },
    {% endfor %}
  ];

  let currentPhotoIndex = 0;
  let currentPhotoId = null;

  function openSwipeModal(data) {
    currentPhotoIndex = photoList.findIndex(p => p.id === data.id);
    if (currentPhotoIndex === -1) return;
    
    updateSwipeModal();
    document.getElementById('swipe-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeSwipeModal() {
    document.getElementById('swipe-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  function nextPhoto() {
    if (currentPhotoIndex < photoList.length - 1) {
      currentPhotoIndex++;
      updateSwipeModal();
    }
  }

  function prevPhoto() {
    if (currentPhotoIndex > 0) {
      currentPhotoIndex--;
      updateSwipeModal();
    }
  }

  function updateSwipeModal() {
    const photo = photoList[currentPhotoIndex];
    if (!photo) return;
    currentPhotoId = photo.id;
    document.getElementById('swipe-img').src = photo.url;
    document.getElementById('swipe-title').textContent = photo.title || 'Sans titre';
    document.getElementById('swipe-desc').textContent = photo.description || '';
    document.getElementById('swipe-author').textContent = photo.author;
    document.getElementById('swipe-date').textContent = photo.date;
    document.getElementById('comment-count').textContent = photo.comment_count;
    
    const downloadBtn = document.getElementById('download-btn');
    if (downloadBtn) downloadBtn.href = photo.url;

    loadLikeState();
  }

  function loadLikeState() {
    if (!currentPhotoId) return;
    fetch(`/photo/${currentPhotoId}/like-status/`)
    .then(r => r.json())
    .then(data => {
      document.getElementById('like-count').textContent = data.likes_count;
      document.getElementById('like-icon').className = data.is_liked
        ? 'bx bxs-heart text-lg text-red-500'
        : 'bx bx-heart text-lg';
    });
  }

  function toggleLike() {
    if (!currentPhotoId) return;
    fetch(`/photo/${currentPhotoId}/like/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById('like-count').textContent = data.likes_count;
        document.getElementById('like-icon').className = data.is_liked
          ? 'bx bxs-heart text-lg text-red-500'
          : 'bx bx-heart text-lg';
      }
    });
  }

  function openComments() {
    if (!currentPhotoId) return;
    loadComments(currentPhotoId);
    document.getElementById('comments-sidebar').classList.remove('translate-x-full');
    document.getElementById('comments-overlay').classList.remove('hidden');
    closeSwipeModal();
  }

  function closeComments() {
    document.getElementById('comments-sidebar').classList.add('translate-x-full');
    document.getElementById('comments-overlay').classList.add('hidden');
  }

  function loadComments(photoId) {
    const list = document.getElementById('comments-list');
    list.innerHTML = '<p class="text-gray-400">Chargement...</p>';
    fetch(`/photo/${photoId}/comments/`)
      .then(r => r.json())
      .then(data => {
        list.innerHTML = '';
        if (data.comments && data.comments.length > 0) {
          data.comments.forEach(comment => {
            const el = document.createElement('div');
            el.className = 'flex gap-3';
            el.innerHTML = `
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-white">
                ${comment.user.first_initial}
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <p class="font-medium text-white">${comment.user.username}</p>
                  <span class="text-gray-500 text-xs">${comment.created_at}</span>
                </div>
                <p class="text-gray-300 text-sm mt-1">${comment.text}</p>
              </div>
            `;
            list.appendChild(el);
          });
        } else {
          list.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="material-icons text-4xl mb-2">forum</i><p>Aucun commentaire pour le moment.</p></div>';
        }
      });
  }

  function addComment(event) {
    event.preventDefault();
    const textInput = document.getElementById('comment-form').querySelector('input[name="text"]');
    const text = textInput.value.trim();
    if (!text || !currentPhotoId) return;

    const formData = new FormData();
    formData.append('text', text);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/photo/${currentPhotoId}/comment/`, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        textInput.value = '';
        // Optimistically add comment to UI
        const list = document.getElementById('comments-list');
        if (list.querySelector('p')) list.innerHTML = ''; // Clear "no comments" message
        const el = document.createElement('div');
        el.className = 'flex gap-3';
        el.innerHTML = `
          <div class="flex-shrink-0 w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-white">
            {{ request.user.username.0|upper }}
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <p class="font-medium text-white">{{ request.user.username }}</p>
              <span class="text-gray-500 text-xs">à l'instant</span>
            </div>
            <p class="text-gray-300 text-sm mt-1">${data.comment.text}</p>
          </div>
        `;
        list.prepend(el);
        
        // Update comment count on modal
        const countEl = document.getElementById('comment-count');
        countEl.textContent = parseInt(countEl.textContent) + 1;
        photoList[currentPhotoIndex].comment_count++;

      } else {
        alert(data.error || 'Impossible d\'ajouter le commentaire.');
      }
    });
  }

  // === ÉVÉNEMENTS ===
  document.getElementById('like-btn')?.addEventListener('click', toggleLike);
  document.getElementById('comment-btn')?.addEventListener('click', openComments);
  document.getElementById('close-swipe')?.addEventListener('click', closeSwipeModal);
  document.getElementById('prev-btn')?.addEventListener('click', prevPhoto);
  document.getElementById('next-btn')?.addEventListener('click', nextPhoto);
  document.getElementById('close-comments')?.addEventListener('click', closeComments);
  document.getElementById('comments-overlay')?.addEventListener('click', closeComments);
  document.getElementById('comment-form')?.addEventListener('submit', addComment);
  document.getElementById('download-disabled')?.addEventListener('click', () => {
    alert('Abonnez-vous pour télécharger !');
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const sidebar = document.getElementById('comments-sidebar');
      const modal = document.getElementById('swipe-modal');
      if (sidebar && !sidebar.classList.contains('translate-x-full')) {
        closeComments();
      } else if (modal && !modal.classList.contains('hidden')) {
        closeSwipeModal();
      }
    }
  });
</script>

{% endblock %}